---
title: 3DGS原理
description: 3DGS前置知识
author: Hatrix
date: 2025-07-09 17:18:00 +0800
categories: [知识储备]
tags: [CV&CG]
math: true
mermaid: true
pin: false
image:
  path: https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/20250709172108224.png
  alt: 3DGS基础
---

## 概述

3DGS 是基于 Splatting 和机器学习的三维重建方法，从 SfM 生成的点云出发，将点膨胀成三维高斯椭球，再通过光栅化投影到二维平面，与真值图像作 loss，反向传播以调整高斯椭球的参数，最终得到完整的场景描述。

3DGS 中的 Splatting 和 NeRF 中的 Ray-Casting 都是渲染的方法。前者是从粒子出发，计算每个粒子对像素的影响；后者是从像素出发，找到影响这个像素的发光粒子。

## 三维高斯表示

对于 SfM 获得的点云，使用三维的高斯函数进行膨胀。之所以选择高斯椭球而不是立方体或球等其它函数是因为高斯函数具有良好的数学性质，一是高斯函数对仿射变换封闭（渲染中需要用到仿射变换），二是三维高斯沿某一个轴积分成二维后仍为高斯函数（渲染实质上就是投影到二维平面）。

高斯函数的表达式如下（高维高斯均假设各向异性，即不同方向梯度不同）

$$
\begin{aligned}
G(x) &= \frac{1}{\sqrt{2\pi\sigma^2}} \exp\left( -\frac{(x - \mu)^2}{2\sigma^2} \right)\\
G(\mathbf{x}) &= \frac{1}{2\pi \sqrt{|\mathbf{\Sigma}|}} \exp\left( -\frac{1}{2} (\mathbf{x} - \mathbf{\mu})^\top \mathbf{\Sigma}^{-1} (\mathbf{x} - \mathbf{\mu}) \right),\\
&\text{其中 } \mathbf{x} = \begin{bmatrix} x_1 \\ x_2 \end{bmatrix},\quad
\mathbf{\mu} = \begin{bmatrix} \mu_1 \\ \mu_2 \end{bmatrix},\quad
\mathbf{\Sigma} = \begin{bmatrix}
\sigma_{11} & \sigma_{12} \\
\sigma_{21} & \sigma_{22}
\end{bmatrix}\\
G(\mathbf{x}) &= \frac{1}{(2\pi)^{3/2} \sqrt{|\mathbf{\Sigma}|}} \exp\left( -\frac{1}{2} (\mathbf{x} - \mathbf{\mu})^\top \mathbf{\Sigma}^{-1} (\mathbf{x} - \mathbf{\mu}) \right),\\
&\text{其中 } \mathbf{x} = \begin{bmatrix} x_1 \\ x_2 \\ x_3 \end{bmatrix},\quad
\mathbf{\mu} = \begin{bmatrix} \mu_1 \\ \mu_2 \\ \mu_3 \end{bmatrix},\quad
\mathbf{\Sigma} = \begin{bmatrix}
\sigma_{11} & \sigma_{12} & \sigma_{13} \\
\sigma_{21} & \sigma_{22} & \sigma_{23} \\
\sigma_{31} & \sigma_{32} & \sigma_{33}
\end{bmatrix}\\
\mathbf{\mu}为均值&，决定分布的形状\\
\mathbf{\Sigma}为协方&差矩阵，为半正定的对称矩阵，对角线元素为方差，其余元素为协方差，决定分布的形状
\end{aligned}
$$

令二维高斯函数为某一常数，提取各高次项系数并整理之后可以得到一个标准的椭圆方程；几何意义上理解更直观：想象一个平面与钟形曲面相交，截出的曲线就是椭圆。

![](https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/20250710192053971.png)

三维高斯同理，令其为常数并提取各高次项系数，整理之后就是一个标准的椭球面方程；在几何意义上为了可视化出来，可以想象用颜色来代表函数值，三维高斯函数就是一个实心椭球，从内到外就是颜色渐变的椭球壳。

![](https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/untitled.jpg)

任意高斯分布可由标准高斯分布通过放射变换得到，对高斯进行仿射变换满足如下规律

$$
\begin{aligned}
\mathbf{x} &\sim \mathcal{N}(\mathbf{\mu}, \mathbf{\Sigma})\\
\mathbf{y} &= \mathbf{A} \mathbf{x} + \mathbf{b}\\
\mathbf{y} &\sim \mathcal{N}(\mathbf{A} \mathbf{\mu} + \mathbf{b},\ \mathbf{A} \mathbf{\Sigma} \mathbf{A}^\top)\\
\end{aligned}
$$

对于标准正态分布，$$\mathbf{\Sigma}=\mathbf{I}$$，$$\mathbf{\Sigma’} = \mathbf{A}\mathbf{I}\mathbf{A}^\top = \mathbf{R}\mathbf{S}\mathbf{S}^\top\mathbf{R}^\top$$，因此可用旋转矩阵和缩放矩阵表达协方差矩阵。已知协方差矩阵，也可以通过特征值分解（EVD）的方式求得相应的旋转矩阵和缩放矩阵。

## Splat 过程

Splat 翻译过来有抛雪球、泼溅的意思，指的是在给定相机位姿的条件下，将由点云膨胀成的三维椭球投射到二维图像平面的过程，具体来说可以细分为四个过程：观测变换、投影变换、视口变换和光栅化。

![](https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/20250710192219269.png)

### 四步变换

观测变换是从世界坐标系转换到相机坐标系的过程，本质上是仿射变换。好比线性代数中基向量的变换，同一向量在不同基下的表达系数不同；同一物体在世界坐标系和相机坐标系中的表达也是不同的，观测变换就是两种坐标系之间的转换。

![](https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/Snipaste_2025-07-10_17-28-46.png)

投影变换是从相机坐标系转换到归一化坐标系（NDC），即二维图像平面的过程，又分为透视投影和正交投影。正交投影即忽略深度，不存在近大远小的效应。透视投影可以看作是先将视锥通过非线性变换化为正交投影相同的情况，视锥最终变换为$$[-1, 1]^3$$范围内的归一化坐标系

![](https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/Snipaste_2025-07-10_17-28-56.png)

以透视投影为例，变换示意图和相应的变换矩阵如下

![](https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/20250710191537752.png)

$$
\begin{aligned}
M_{\text{persp} \rightarrow \text{ortho}} &=
\begin{bmatrix}
n & 0 & 0 & 0 \\
0 & n & 0 & 0 \\
0 & 0 & n + f & -nf \\
0 & 0 & 1 & 0
\end{bmatrix}\quad 由非线性变换将透视投影转化为正交投影\\
M_{\text{ortho}} &=
\begin{bmatrix}
\frac{2}{r - l} & 0 & 0 & 0 \\
0 & \frac{2}{t - b} & 0 & 0 \\
0 & 0 & \frac{2}{n - f} & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
1 & 0 & 0 & -\frac{r + l}{2} \\
0 & 1 & 0 & -\frac{t + b}{2} \\
0 & 0 & 1 & -\frac{n + f}{2} \\
0 & 0 & 0 & 1
\end{bmatrix}\quad 分别为缩放和平移矩阵
\end{aligned}
$$

视口变换是将投影得到的归一化设备坐标系还原到符合图像长宽的图像坐标系过程，与深度无关，将$$[-1, 1]^2$$的矩形还原到$$[0, w] \times [0, h]$$

![](https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/20250710210943404.png)

变换矩阵为

$$
M_{\text{viewport}} =
\begin{bmatrix}
\frac{w}{2} & 0 & 0 & \frac{w}{2} \\
0 & \frac{h}{2} & 0 & \frac{h}{2} \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}
$$

光栅化是将连续图像坐标系离散采样到像素坐标系的过程，根据像素中心点是否在图像中决定是否渲染该像素

![](https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/20250710212143946.png)

### 高斯球的四步变换

设世界坐标系下的高斯核中心为$$\mathbf{t}_k= [t_{0}\ t_{1}\ t_{2}]^{\top}$$，协方差矩阵为$$\mathbf{V}''_k$$，高斯核为$$r''(k)=G_{\mathbf{V}''_k}(\mathbf{t} - \mathbf{t}_k)$$；

相机坐标系下的高斯核中心为$$\mathbf{u}_k= [u_{0}\ u_{1}\ u_{2}]^{\top}$$，协方差矩阵为$$\mathbf{V}'_k$$，高斯核为$$r'(k)=G_{\mathbf{V}'_k}(\mathbf{u} - \mathbf{u}_k)$$；

归一化坐标系下的高斯核中心为$$\mathbf{x}_k= [x_{0}\ x_{1}\ x_{2}]^{\top}$$，协方差矩阵为$$\mathbf{V}_k$$，高斯核为$$r(k)=G_{\mathbf{V}_k}(\mathbf{x} - \mathbf{x}_k)$$；

观测变换为$$\mathbf{u}=\mathbf{W}\mathbf{t} + \mathbf{d}$$，则$$\mathbf{u}_k = \mathbf{W}\mathbf{t}_k + \mathbf{d}，\mathbf{V}'_k = \mathbf{W}\mathbf{V}''_k\mathbf{W}^\top$$；

投影变换为$$\mathbf{x}=m(\mathbf{u})$$，雅可比矩阵为$$\mathbf{J}$$，则$$\mathbf{x}_k = m(\mathbf{u}_k)，\mathbf{V}_k = \mathbf{J}\mathbf{V}'_k\mathbf{J}^\top = \mathbf{J}\mathbf{W}\mathbf{V}''_k\mathbf{W}^\top\mathbf{J}^\top$$。

由于投影变换为非线性变换，而希望高斯椭球只进行线性的仿射变换，对于均值这一个点可以直接应用非线性的投影变换，不存在形变的问题；而协方差则需要用雅可比矩阵在高斯核中心进行局部线性化。操作之后，均值在归一化坐标系中，需要后续的视口变换；而协方差在未缩放未平移的正交坐标系中，不需要作视口变换。

假设视锥中的点为$$[x\ y\ z\ 1]^\top$$（写成齐次形式），可以求出变换到正交坐标系中的对应坐标，由此可求得雅可比矩阵
$$
\begin{aligned}
\begin{bmatrix}
n & 0 & 0 & 0 \\
0 & n & 0 & 0 \\
0 & 0 & n + f & -nf \\
0 & 0 & 1 & 0
\end{bmatrix}
\begin{bmatrix}
x \\
y \\
z \\
1
\end{bmatrix}
&=
\begin{bmatrix}
nx \\
ny \\
(n + f)z - nf \\
z
\end{bmatrix} 
=
\begin{bmatrix}
\frac{nx}{z} \\
\frac{ny}{z} \\
(n + f)-\frac{nf}{z} \\
1
\end{bmatrix}
=
\begin{bmatrix}
f(x) \\
f(y) \\
f(z) \\
1
\end{bmatrix}\\
\mathbf{J}  &= 
\begin{bmatrix}
\frac{\text{d}f(x)}{\text{d}x}&\frac{\text{d}f(x)}{\text{d}y}&\frac{\text{d}f(x)}{\text{d}z}\\
\frac{\text{d}f(y)}{\text{d}x}&\frac{\text{d}f(y)}{\text{d}y}&\frac{\text{d}f(y)}{\text{d}z}\\
\frac{\text{d}f(z)}{\text{d}x}&\frac{\text{d}f(z)}{\text{d}y}&\frac{\text{d}f(z)}{\text{d}z}
\end{bmatrix} = 
\begin{bmatrix}
\frac{n}{z}&0&-\frac{nx}{z^{2}}\\
0&\frac{n}{z}&-\frac{ny}{z^{2}}\\
0&0&\frac{n f}{z^{2}}
\end{bmatrix}
\end{aligned}
$$

## 相机模型

相机模型指三维坐标点到二维成像平面的几何映射关系。相机根据视场角（Field Of Vision）的大小分为：普通相机（FOV小于90度）、广角相机（FOV大于90度，小于180度）和全向相机（FOV大于180度）。不同视场角相机的成像模型不同。

### 针孔相机模型

针孔相机模型又称直线投影模型。设相机坐标系为$$xOy$$，成像坐标系为$$x'Oy'$$，像素坐标系为$$uOv$$。三维坐标为$$(X, Y, Z)$$，成像平面坐标为$$(X', Y')$$，相机光心到物理成像平面距离为焦距$$f$$，有$$\frac{Z}{f}=-\frac{X}{X^{\prime}}=-\frac{Y}{Y^{\prime}}$$，负号表示成像倒立。像素坐标系原点在图像左上角，成像坐标系和像素坐标系存在一个缩放和平移的关系。

![](https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/20250710231245226.png)



## 仿射变换

仿射变换是通过线性变换和平移来改变对象的位置和形状，保持原有对象的直线性和平移性，即二维图形之间的相对位置保持不变，平行线依然是平行线，且直线上的点的位置顺序不变的几何变换；可以实现平移、旋转、缩放和剪切等操作。另外，在进行多个仿射变换时，他们的顺序会影响最终结果。

![](https://cdn.jsdelivr.net/gh/SparkyXXX/Hatrix-s-Blog-Image/img/20250710164756686.png)

仿射变换可以表示为乘以一个矩形（这个矩阵又可以分解为旋转矩阵和缩放矩阵的乘积）再加上一个向量的形式。为了方便表示连续的仿射变换，也可以用齐次形式表示

$$
\begin{aligned}
\mathbf{y} &= \mathbf{A} \cdot\mathbf{x} + \mathbf{b} = \mathbf{R}\mathbf{S}\cdot \mathbf{x} + \mathbf{b}\\
\begin{bmatrix}
\mathbf{y} \\
1
\end{bmatrix}
&=
\begin{bmatrix}
\mathbf{A} & \mathbf{b} \\
\mathbf{0}^\top & 1
\end{bmatrix}
\begin{bmatrix}
\mathbf{x} \\
1
\end{bmatrix}
\end{aligned}
$$

## 参考资料

[3DGS 原理讲解](https://www.bilibili.com/video/BV1rJ4m1g7Un/)

[仿射变换](https://www.cnblogs.com/wj-1314/p/17633789.html)

[仿射变换矩阵](https://www.cnblogs.com/shine-lee/p/10950963.html)

[相机模型](https://zhuanlan.zhihu.com/p/461783794)
